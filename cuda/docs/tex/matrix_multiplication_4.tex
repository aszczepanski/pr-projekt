
\subsection{Wersja 4}

\subsubsection{Opis rozwiązania}

Jest to rozszerzona wersja 3 o równoległe z obliczeniami pobranie kolejnych danych (na poziomie bloku). Ma to spowodować złagodzenie kosztów synchronizacji.

\begin{enumerate}[(a)]

\item \textbf{Pobranie do rejestru} \newline

\lstinputlisting[caption=Mnożenie macierzy kwadratowych na GPU -- wersja 4 z pobraniem do rejestru.]{./code/matrix_multiplication_4a.cpp}

\item \textbf{Pobranie do pamięci współdzielonej} \newline

\lstinputlisting[caption=Mnożenie macierzy kwadratowych na GPU -- wersja 4 z pobraniem do pamięci współdzielonej.]{./code/matrix_multiplication_4b.cpp}

\end{enumerate}

\subsubsection{Teoretyczna zajętość SM}

\begin{enumerate}[(a)]

\item \textbf{Pobranie do rejestru} \newline

\begin{center}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{2}{|c|}{\multirow{2}{*}{Kryterium}} & \multicolumn{2}{c|}{Teoretyczna wartość} & \multirow{2}{*}{Limit GPU} \\ \cline{3-4}
\multicolumn{2}{|c|}{} & 8x8 & 16x16 & \\ \hline
\multirow{4}{*}{Zajętość SM} & Aktywne bloki & 8 & 4 & 8 \\ \cline{2-5}
& Aktywne warpy & 16 & 32 & 32 \\ \cline{2-5}
& Aktywne wątki & 512 & 1024 & 1024 \\ \cline{2-5}
& Zajętość & 50\% & 100\% & 100\% \\ \hline
\multirow{3}{*}{Warpy} & Wątki/Blok & 64 & 256 & 512 \\ \cline{2-5}
& Warpy/Blok & 2 & 8 & 16 \\ \cline{2-5}
& Limit bloków & 16 & \textcolor{red}{\textbf{4}} & 8 \\ \hline
\multirow{3}{*}{Rejestry} & Rejestry/Wątek & 13 & 13 & 128 \\ \cline{2-5}
& Rejestry/Blok & 1024 & 3584 & 16384 \\ \cline{2-5}
& Limit bloków & 16 & \textcolor{red}{\textbf{4}} & 8 \\ \hline
\multirow{2}{*}{Pamięć współdzielona} & Pamięć współdzielona/Blok & 556 & 2092 & 16384 \\ \cline{2-5}
& Limit bloków & 16 & 6 & 8 \\ \hline
\end{tabular}
\caption{Teoretyczna zajętość SM -- wersja 4. z pobraniem do rejestru.}
\end{table}
\end{center}

Podobnie jak dla poprzednich wersji, dla bloku 8x8 limitem okazuje się być maksymalna ilość bloków na SM, stąd zajętość $ 16 / 32 = 50\% $. \\
Dla macierzy 16x16 limitem są warpy i rejestry. Przypada odpowiednio $ 8 $ warpów na blok, co daje limit $ 4 $ aktywnych bloków. $ 3584 $ rejestrów na blok również daje limit $ 4 $ aktywnych bloków. Zajętość dla bloku 16x16 wynosi $ 100\% $. \\

\item \textbf{Pobranie do pamięci współdzielonej} \newline

\begin{center}
\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{2}{|c|}{\multirow{2}{*}{Kryterium}} & \multicolumn{2}{c|}{Teoretyczna wartość} & \multirow{2}{*}{Limit GPU} \\ \cline{3-4}
\multicolumn{2}{|c|}{} & 8x8 & 16x16 & \\ \hline
\multirow{4}{*}{Zajętość SM} & Aktywne bloki & 8 & 3 & 8 \\ \cline{2-5}
& Aktywne warpy & 16 & 24 & 32 \\ \cline{2-5}
& Aktywne wątki & 512 & 768 & 1024 \\ \cline{2-5}
& Zajętość & 50\% & 75\% & 100\% \\ \hline
\multirow{3}{*}{Warpy} & Wątki/Blok & 64 & 256 & 512 \\ \cline{2-5}
& Warpy/Blok & 2 & 8 & 16 \\ \cline{2-5}
& Limit bloków & 16 & 4 & 8 \\ \hline
\multirow{3}{*}{Rejestry} & Rejestry/Wątek & 14 & 14 & 128 \\ \cline{2-5}
& Rejestry/Blok & 1024 & 3584 & 16384 \\ \cline{2-5}
& Limit bloków & 16 & 4 & 8 \\ \hline
\multirow{2}{*}{Pamięć współdzielona} & Pamięć współdzielona/Blok & 1068 & 4140 & 16384 \\ \cline{2-5}
& Limit bloków & 16 & \textcolor{red}{\textbf{3}} & 8 \\ \hline
\end{tabular}
\caption{Teoretyczna zajętość SM -- wersja 4. z pobraniem do pamięci współdzielonej.}
\end{table}
\end{center}

Podobnie jak dla poprzednich wersji, dla bloku 8x8 limitem okazuje się być maksymalna ilość bloków na SM, stąd zajętość $ 16 / 32 = 50\% $. \\
Dla macierzy 16x16 limitem jest pamięć współdzielona. $4140$ bajtów na blok daje limit $3$ aktywnych bloków. W porównaniu z poprzednimi wersjami zajętość SM dla bloku 16x16 spada i wynosi $ 75\% $. \\

\end{enumerate}

\subsubsection{Wyniki pomiarów}

\begin{enumerate}[(a)]

\item \textbf{Pobranie do rejestru} \newline

\begin{enumerate}[1.]

\item \textbf{Czas trwania obliczeń} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 0.145 & 0.091 \\ \hline
256x256 & 0.940 & 0.525 \\ \hline
384x384 & 3.062 & 1.632 \\ \hline
512x512 & 7.093 & 3.809 \\ \hline
640x640 & 13.950 & 7.356 \\ \hline
\end{tabular}
\caption{Czas obliczeń [ms] -- wersja 4. z pobraniem do rejestru.}
\end{table}

\item \textbf{Ilość operacji zmiennoprzecinkowych na sekundę} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 28.953 & 45.894 \\ \hline
256x256 & 35.697 & 63.856 \\ \hline
384x384 & 36.987 & 69.405 \\ \hline
512x512 & 37.844 & 70.472 \\ \hline
640x640 & 37.583 & 71.269 \\ \hline
\end{tabular}
\caption{Ilość operacji zmiennoprzecinkowych na sekundę (GFLOPS) -- wersja 4. z pobraniem do rejestru.}
\end{table}

\item \textbf{Ilość instrukcji na sekundę} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 0.1448 & 0.1639 \\ \hline
256x256 & 0.1787 & 0.2665 \\ \hline
384x384 & 0.1821 & 0.3020 \\ \hline
512x512 & 0.1848 & 0.2983 \\ \hline
640x640 & 0.1815 & 0.3013 \\ \hline
\end{tabular}
\caption{Ilość instrukcji wykonana na sekundę (GIPS) -- wersja 4. z pobraniem do rejestru.}
\end{table}

\item \textbf{CGMA} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 120.471 & 485.452 \\ \hline
256x256 & 124.121 & 489.531 \\ \hline
384x384 & 125.388 & 491.520 \\ \hline
512x512 & 125.908 & 498.432 \\ \hline
640x640 & 126.499 & 500.764 \\ \hline
\end{tabular}
\caption{Stosunek ilości operacji zmiennoprzecinkowych do ilości operacji odczytu/zapisu z pamięci globalnej -- wersja 4. z pobraniem do rejestru.}
\end{table}

\end{enumerate}

\item \textbf{Pobranie do pamięci współdzielonej} \newline

\begin{enumerate}[1.]

\item \textbf{Czas trwania obliczeń} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 0.156 & 0.093 \\ \hline
256x256 & 1.069 & 0.610 \\ \hline
384x384 & 3.461 & 1.956 \\ \hline
512x512 & 8.023 & 4.430 \\ \hline
640x640 & 15.838 & 8.606 \\ \hline
\end{tabular}
\caption{Czas obliczeń [ms] -- wersja 4. z pobraniem do pamięci współdzielonej.}
\end{table}

\item \textbf{Ilość operacji zmiennoprzecinkowych na sekundę} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 26.892 & 45.291 \\ \hline
256x256 & 31.394 & 55.012 \\ \hline
384x384 & 32.723 & 57.902 \\ \hline
512x512 & 33.458 & 60.593 \\ \hline
640x640 & 33.103 & 60.919 \\ \hline
\end{tabular}
\caption{Ilość operacji zmiennoprzecinkowych na sekundę (GFLOPS) -- wersja 4. z pobraniem do pamięci współdzielonej.}
\end{table}

\item \textbf{Ilość instrukcji na sekundę} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 0.1918 & 0.2248 \\ \hline
256x256 & 0.1904 & 0.2944 \\ \hline
384x384 & 0.1934 & 0.2812 \\ \hline
512x512 & 0.1958 & 0.2932 \\ \hline
640x640 & 0.1927 & 0.2920 \\ \hline
\end{tabular}
\caption{Ilość instrukcji wykonana na sekundę (GIPS) -- wersja 4. z pobraniem do pamięci współdzielonej.}
\end{table}

\item \textbf{CGMA} \newline

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\multirow{2}{*}{Rozmiar macierzy} & \multicolumn{2}{c|}{Rozmiar bloku} \\ \cline{2-3}
& 8x8 & 16x16 \\ \hline
128x128 & 115.076 & 520.127 \\ \hline
256x256 & 124.608 & 481.882 \\ \hline
384x384 & 125.388 & 494.957 \\ \hline
512x512 & 126.031 & 496.485 \\ \hline
640x640 & 126.657 & 498.267 \\ \hline
\end{tabular}
\caption{Stosunek ilości operacji zmiennoprzecinkowych do ilości operacji odczytu/zapisu z pamięci globalnej -- wersja 4. z pobraniem do rejestru.}
\end{table}

\end{enumerate}

\end{enumerate}
